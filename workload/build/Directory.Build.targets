<Project>

  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.Arcade.Sdk" Version="$(MicrosoftDotNetBuildTasksFeedPackageVersion)" PrivateAssets="all" GeneratePathProperty="true" />
  </ItemGroup>

  <Import Project="..\src\Samsung.Tizen.Build.PrepTasks\PrepTasks.targets" />
  <Import Project="Sdk.props" Sdk="Microsoft.DotNet.SharedFramework.Sdk" Version="$(MicrosoftDotNetBuildTasksFeedPackageVersion)" />

  <PropertyGroup>
    <NuGetLicense Condition=" '$(NuGetLicense)' == '' ">..\LICENSE</NuGetLicense>
    <PackageLicenseFile>LICENSE</PackageLicenseFile>
    <PackageId Condition="'$(CreateMsiNuGet)' != 'True'">$(ProductName)</PackageId>
    <PackageId Condition="'$(CreateMsiNuGet)' == 'True'">$(ProductName).Msi.x64</PackageId>
  </PropertyGroup>

  <PropertyGroup>
    <BeforePack Condition="'$(CreateMsiNuGet)' != 'True'">
      $(BeforePackDependsOn);
      $(BeforePack);
    </BeforePack>
    <BeforePack Condition="'$(CreateMsiNuGet)' == 'True'">
      _GenerateMSIContent;
      $(BeforePack);
    </BeforePack>
  </PropertyGroup>

  <Target Name="_GetPackageVersion">
    <Error Condition="'$(TizenPackVersion)' == ''" Text="TizenPackVersion property is not set." />
    <PropertyGroup>
      <PackageVersion Condition="'$(TizenVersionHash)' != ''">$(TizenPackVersion)+sha.$(TizenVersionHash)</PackageVersion>
      <PackageVersion Condition="'$(TizenVersionHash)' == ''">$(TizenPackVersion)</PackageVersion>
    </PropertyGroup>
  </Target>

  <!-- https://github.com/xamarin/xamarin-android/blob/c703fa9431894132619e50e04a04eb3543b1f62f/build-tools/create-packs/Directory.Build.targets#L27 -->
  <Target Name="_GetLicense">
    <!-- NuGet doesn't have a way to change the filename of License.txt, so copy it -->
    <Copy
        SourceFiles="$(NuGetLicense)"
        DestinationFiles="$(IntermediateOutputPath)$(PackageLicenseFile)"
        SkipUnchangedFiles="true"
    />
    <ItemGroup>
      <_PackageFiles Include="$(IntermediateOutputPath)$(PackageLicenseFile)" PackagePath="\" />
    </ItemGroup>
  </Target>

  <Target Name="_GenerateMsiContent" DependsOnTargets="_GetPackageVersion;_GetLicense;_GenerateMsiBundle">
    <ItemGroup>
      <_PackageFiles Include="$(_DestinationMsiFile)" PackagePath="data" />
      <_PackageFiles Include="$(MSIOutputPath)$(ProductName)\msi.json" PackagePath="data" />
    </ItemGroup>
  </Target>

  <Target Name="_GenerateMsiBundle">
    <PropertyGroup>
      <TargetDotnetDirectory Condition="'$(TargetDotnetDirectory)' != ''">$([MSBuild]::EnsureTrailingSlash('$(TargetDotnetDirectory)'))</TargetDotnetDirectory>
      <_DestinationMsiFile>$(MSIOutputPath)$(ProductName)\$(ProductName).$(TizenPackVersion)-x64.msi</_DestinationMsiFile>
      <_DestinationWixFile>$(MSIOutputPath)$(ProductName)\$(ProductName).$(TizenPackVersion).wix</_DestinationWixFile>
    </PropertyGroup>
    <GenerateWixFile
      SourceFile="$(MSBuildThisFileDirectory)Template.in.wix"
      ProductName="$(ProductName)"
      ProductCode="$(ProductCode)"
      ProductVersion="$(ProductVersion)"
      WorkloadVersion="$(TizenPackVersion)"
      UpgradeCode="$(UpgradeCode)"
      DestinationFile="$(_DestinationWixFile)"
      BaseDirectory="$(TargetDotnetDirectory)"
      SourceDirectory="$(TargetDotnetDirectory)$(InstallDirectory)"
      />
    <Exec Command="wixl -o $(_DestinationMsiFile) $(_DestinationWixFile) -a x64" />
  </Target>

</Project>
